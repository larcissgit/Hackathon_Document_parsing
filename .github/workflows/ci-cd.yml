name: CI/CD авто-верификатора ГОСТ

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # 1. ТЕСТИРОВАНИЕ КОДА
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]  # Одна версия для скорости
    
    steps:
      - name: Клонирование репозитория
        uses: actions/checkout@v4
      
      - name: Установка Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Установка системных зависимостей
        run: |
          sudo apt-get update
          sudo apt-get install -y antiword poppler-utils
      
      - name: Установка Python-зависимостей
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov  # Только для тестов
      
      - name: Запуск тестов
        run: |
          python -m pytest tests/ -v --cov=src --cov-report=xml --cov-report=html
      
      - name: Проверка качества кода (линтер)
        run: |
          pip install flake8
          flake8 src/ --count --max-line-length=127 --statistics
      
      - name: Проверка форматирования (опционально)
        run: |
          pip install black
          black --check src/
  
  # 2. СБОРКА DOCKER-ОБРАЗА (только для main)
  docker-build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Клонирование репозитория
        uses: actions/checkout@v4
      
      - name: Настройка Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Сборка Docker-образа
        run: |
          docker build -t autoverifier-gost:latest .
      
      - name: Проверка работы образа
        run: |
          # Создаём тестовый документ
          echo "Введение\nНазначение\nТехнические характеристики" > test.txt
          # Запускаем проверку через Docker
          docker run --rm -v $(pwd)/test.txt:/app/test.txt autoverifier-gost:latest test.txt --output test_report.json
          # Проверяем, что отчёт создался
          if [ -f "test_report.json" ]; then
            echo "✅ Docker-образ работает корректно"
          else
            echo "❌ Docker-образ не работает"
            exit 1
          fi